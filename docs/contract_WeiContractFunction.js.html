<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>contract/WeiContractFunction.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-install.html">Getting Started</a></li><li class="nav-item"><a href="tutorial-usage.html">Using Wei.js</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Wei.html">Wei</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Wei.html#contract">contract</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiABIType.html">WeiABIType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiABIType.html#parse">parse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiABIType.html#parseType">parseType</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiAccount.html">WeiAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccount.html#balance">balance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccount.html#sendTransaction">sendTransaction</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiAccountManager.html">WeiAccountManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccountManager.html#addAccount">addAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccountManager.html#addKeyAccount">addKeyAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccountManager.html#addRPCAccount">addRPCAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccountManager.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccountManager.html#has">has</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiAccountManager.html#newKeyAccount">newKeyAccount</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiContract.html">WeiContract</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContract.html#at">at</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContract.html#deploy">deploy</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiContractEvent.html">WeiContractEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContractEvent.html#createFilter">createFilter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContractEvent.html#find">find</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContractEvent.html#listen">listen</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiContractEventListener.html">WeiContractEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContractEventListener.html#cancel">cancel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContractEventListener.html#listen">listen</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContractEventListener.html#query">query</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiContractFunction.html">WeiContractFunction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiContractFunction.html#exec">exec</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiEventABI.html">WeiEventABI</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiEventABI.html#decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiEventABI.html#sig">sig</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiFunctionABI.html">WeiFunctionABI</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiFunctionABI.html#decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiFunctionABI.html#encode">encode</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiHttpProvider.html">WeiHttpProvider</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiHttpProvider.html#send">send</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiKeyAccount.html">WeiKeyAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiKeyAccount.html#.create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiKeyAccount.html#nonce">nonce</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiKeyAccount.html#sendTransaction">sendTransaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiKeyAccount.html#sign">sign</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiProvider.html">WeiProvider</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiProvider.html#rpc">rpc</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiProvider.html#send">send</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiRLP.html">WeiRLP</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiRLP.html#.decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiRLP.html#.encode">encode</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiRPC.html">WeiRPC</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiRPC.html#modules">modules</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiRPCAccount.html">WeiRPCAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiRPCAccount.html#sendTransaction">sendTransaction</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiTransaction.html">WeiTransaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTransaction.html#.fromObject">fromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTransaction.html#encode">encode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTransaction.html#sign">sign</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTransaction.html#toObject">toObject</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiType.html">WeiType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiType.html#decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiType.html#encode">encode</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiTypeBytes.html">WeiTypeBytes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeBytes.html#decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeBytes.html#encode">encode</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiTypeDynamic.html">WeiTypeDynamic</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeDynamic.html#decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeDynamic.html#encode">encode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeDynamic.html#size">size</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiTypeFixed.html">WeiTypeFixed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeFixed.html#decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeFixed.html#encode">encode</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiTypeNumber.html">WeiTypeNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeNumber.html#decode">decode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiTypeNumber.html#encode">encode</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiTypeTuple.html">WeiTypeTuple</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiUtil.html">WeiUtil</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiUtil.html#.hash">hash</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiUtil.html#.hex">hex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiUtil.html#.isObj">isObj</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WeiWeb3Provider.html">WeiWeb3Provider</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WeiWeb3Provider.html#send">send</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">contract/WeiContractFunction.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const BN = require('bn.js');
const WeiABI = require('./abi/WeiFunctionABI.js');
const WeiAccount = require('../account/WeiAccount.js');
const WeiTransaction = require('../account/WeiTransaction.js');
const WeiUtil = require('../WeiUtil.js');

/** 
 * Convert a key to hex, if not present using a default parameter.
 *
 * @param {Object} obj - Object to operate on.
 * @param {string} name - Name of the key to check.
 * @param {*} def - Default parameter if not found on the obj.
 *
 * @private
 */
function defaultToHex(obj, name, def) {
    obj[name] = obj[name] || new BN(def);

    if ( typeof def != 'object' ) {
        if ( obj.constructor.name != 'BN' ) {
            obj[name] = new BN(obj[name]);
        }

        obj[name] = WeiUtil.hex(obj[name]);
    }
    else if ( def instanceof Buffer) {
        obj[name] = WeiUtil.hex(obj[name] || def);
    }
}

/**
 * Used to validate that the last parameter of the {@link WeiContractFunction#exec} is a transaction object.
 *
 * @param {Object} txObj - The object to validate.
 * @returns {boolean} Whether or not is a proper object.
 *
 * @private
 */
function validateTxObj(txObj) {
    if ( !WeiUtil.isObj(txObj) ) {
        return false;
    }

    if ( typeof txObj['to'] != 'string' ) {
        return false;
    }

    return true;
}

/**
 * A class that wraps a function for a given contract
 *
 * @description When the {@link WeiContract} parses its ABI, it will generate a {@WeiContractFunction}
 * for each function specified in the ABI. When {@link WeiContract#address} is called, it will automatically 
 * pass the address down to the events it has generated. {@link WeiContractFunction#exec} is exposed directly
 * on the {@link WeiContract}. 
 *
 * @example
 * const contract = wei.contract(SimpleStorage.abi);
 * const account = wei.accounts.newKeyAccount();
 * await contract.deploy(SimpleStorage.bytecode, '0x1234567890', { from: account });
 * console.log(contract.address);
 * 
 * console.log('Output 1:', (await contract.get()).output[0].toString(16));
 * 
 * await contract.set('0xdeadbeef', { from: account });
 * console.log('Output 2:', (await contract.get()).output[0].toString(16));
 * 
 * await contract.setFirst(['0xcafebabe'], {from: account});
 * console.log('Output 3:', (await contract.get()).output[0].toString(16));
 */
class WeiContractFunction {
    /**
     * Create a contract function.
     * 
     * @param {Wei} wei - The wei instance to use.
     * @param {Object} abi - The ABI of the function to use.
     */
    constructor(wei, abi) {
        this._wei = wei;
        this.abi = new WeiABI(abi);
        this.constant = abi.constant;
    }

    /**
     * Execute the given function.
     *
     * @param {...*} args - The arguments of the constructor. These are optional.
     * @param {Object} txObj - The last argument should be a transaction object,
     * containing the sender, and gas information. However if you're calling a
     * constant function and the from field is important to you, the rest will
     * be loaded in and won't be necessary.
     * @returns {Object} The result of the function call.
     */
    async exec(... args) {
        const txObj = args.length > 0 ? args.pop() : {};

        // Put in the transaction arguments from the ABI/other places
        txObj['to'] = txObj['to'] || this._address;
        txObj['const'] = txObj['const'] == undefined ? this.constant : txObj['const'];

        if ( !validateTxObj(txObj) ) {
            throw new Error("Last argument to a function must be the txobj");
        }

        const encode = this.abi.encode(args);
        const res = {};

        defaultToHex(txObj, 'data', encode);

        // Load sender and make sure txObj is well formed
        const sender = txObj['from'];

        if ( sender instanceof WeiAccount ) {
            txObj['from'] = sender.address;
        }

        // Get output of function - this works even on non-constant functions
        // TODO - does this introduce a race condition where the output can be different
        // because of alternative transactions affecting the contract?
        res['rawOutput'] = await this._wei.rpc.eth.call(txObj, 'latest');
        res['output'] = this.abi.decode(Buffer.from(res['rawOutput'].substring(2), 'hex'));

        // If not a constant function, send transaction.
        if ( !txObj['const'] ) {
            // Execute the transaction and find the receipt
            if ( typeof sender == 'string') {
                res['txHash'] = await this._wei.rpc.eth.sendTransaction(txObj);                
            }
            else if ( sender instanceof WeiAccount ) {
                res['txHash'] = await sender.sendTransaction(WeiTransaction.fromObject(txObj));
            }
            else {
                throw new Error("Unknown item in the 'from' field of transaction");
            }

            res['txReceipt'] = await this._wei.rpc.eth.getTransactionReceipt(res['txHash']);

            if ( res['txReceipt']['status'] == '0x0' ) {
                throw new Error('Transaction returned status 0');
            }
        }

        return res;
    }
}

module.exports = WeiContractFunction;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jul 06 2018 18:03:00 GMT-0400 (Eastern Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
